<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ZAP48 • Formation Machine (BRAT v3)</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --primary:#8ACE00;
      --black:#000;
      --white:#fff;
      --bg:#f4f4f4;
      --border:2px solid #000;
      --shadow:4px 4px 0px #000;
      --shadow-sm:2px 2px 0px #000;
      --radius:16px;
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
    body{
      background: var(--bg);
      color: var(--black);
      font-family: Roboto, system-ui, Arial;
      padding: 16px 12px 40px;
      overflow-x:hidden;
    }
    h1,h2,h3,h4,.font-head{
      font-family: Montserrat, sans-serif;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: -0.5px;
    }

    .wrap{max-width: 720px; margin:0 auto;}
    .header{
      background: var(--bg);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position: sticky;
      top: 10px;
      z-index: 10;
    }
    .logo{font-family: Montserrat;font-weight: 900;font-size: 1.1rem;font-style: italic; line-height:1;}
    .logo span{ color: var(--primary); }

    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    select{
      padding: 10px 12px;
      border: var(--border);
      border-radius: 10px;
      background:#fff;
      font-family: Montserrat;
      font-weight: 900;
      box-shadow: var(--shadow-sm);
    }
    .btn{
      border: var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-family: Montserrat;
      font-weight: 900;
      cursor:pointer;
      box-shadow: var(--shadow-sm);
      text-transform: uppercase;
      background: var(--primary);
      color: #000;
      transition: transform .12s ease;
      white-space:nowrap;
    }
    .btn:active{ transform: scale(.97); }
    .btn.alt{ background:#fff; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .card{
      margin-top: 14px;
      background:#fff;
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .screen{ padding: 14px; }
    .hidden{ display:none !important; }
    .fadeUpIn{ animation: fadeUpIn .35s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeUpIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* ===== OVERVIEW ===== */
    .ovTop{display:flex;justify-content:space-between;align-items:baseline;gap:10px;margin-bottom: 10px;}
    .tag{display:inline-block;background: var(--primary);color:#000;font-weight: 900;font-size: .65rem;padding: 4px 10px;border-radius: 4px;border: 1px solid #000;}
    .ovHint{ font-size: .75rem; font-weight: 800; color:#333; }

    .rows{ display:flex; flex-direction:column; gap:14px; }
    .rowLabel{text-align:center;margin-top: 4px;font-family: Montserrat;font-weight: 900;font-size: .8rem;}
    .rowDots{ display:flex; justify-content:center; flex-wrap:wrap; gap:10px; }

    .dot{
      width: 66px; height: 66px;
      border-radius: 999px;
      border: var(--border);
      box-shadow: var(--shadow-sm);
      background: #fff;
      overflow:hidden;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      transform: translateZ(0);
    }
    .rows[data-tight="7"] .dot{ width: 56px; height:56px; }
    .rows[data-tight="7"] .dot .num{ font-size: 12px; }
    .rows[data-tight="8"] .dot{ width: 50px; height:50px; }
    .rows[data-tight="8"] .dot .num{ font-size: 11px; }

    .dot img{
      width:100%;
      height:100%;
      object-fit:cover;
      opacity:0;
      transform:scale(1.02);
      transition: opacity .22s ease, transform .35s ease;
    }
    .dot .q{position:absolute;font-family: Montserrat;font-weight: 900;font-size: 26px;color:#000;opacity:.9;}
    .dot .num{
      position:absolute; bottom:4px; left:0; right:0;
      text-align:center;
      font-family: Montserrat;
      font-weight: 900;
      font-size: 14px;
      color:#000;
      background: rgba(138,206,0,.85);
      border-top: 1px solid #000;
      padding: 1px 0;
    }
    .dot.revealed img{ opacity:1; transform: scale(1); }
    .dot.revealed .q{ display:none; }

    /* center badge */
    .dot.center{ background: var(--primary); }
    .dot.center .num{ background:#000; color: var(--primary); }
    .dot.center::after{
      content:"★";
      position:absolute;
      top:4px; right:6px;
      width:18px; height:18px;
      border-radius:999px;
      border: 2px solid #000;
      background:#ffd700;
      display:flex; align-items:center; justify-content:center;
      font-size: 12px;
      font-family: Montserrat;
      font-weight: 900;
      box-shadow: 2px 2px 0 #000;
      transform: rotate(10deg);
    }

    /* ===== MACHINE ===== */
    .machineGrid{
      display:grid;
      grid-template-columns: 140px 1fr 140px;
      gap: 12px;
      align-items:stretch;
    }
    .panel{
      background:#fff;
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 12px;
    }
    .rowTag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-family: Montserrat;
      font-weight: 900;
      font-size: .75rem;
      padding: 6px 10px;
      border: var(--border);
      border-radius: 999px;
      background: #fff;
      box-shadow: var(--shadow-sm);
    }
    .bigNoWrap{
      margin-top: 12px;
      height: 120px;
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      display:flex;
      align-items:center;
      justify-content:center;
      background: var(--primary);
      position:relative;
      overflow:hidden;
    }
    .bigNo{
      font-family: Montserrat;
      font-weight: 900;
      font-size: 64px;
      color:#000;
      letter-spacing:-2px;
      text-shadow: 2px 2px 0 #fff;
    }

    .slot{
      background:#fff;
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 10px;
      min-height: 440px;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
      position:relative;
      overflow:hidden;
    }
    .slotArch{
      width: 100%;
      height: 100%;
      border: var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow-sm);
      background: #000;
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .slotArch.lit::before{
      content:"";
      position:absolute;
      inset: -6px;
      border-radius: 28px;
      border: 4px solid var(--primary);
      filter: drop-shadow(0 0 10px rgba(138,206,0,.9));
      animation: blink 0.18s steps(2) infinite;
      pointer-events:none;
      z-index: 9;
    }
    @keyframes blink{
      0%{opacity:.2}
      50%{opacity:1}
      100%{opacity:.2}
    }

    .reel{
      position:absolute;
      inset: 12px;
      border-radius: 16px;
      background: #111;
      border: 2px solid #fff;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 1;
    }
    .reelList{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      will-change: transform;
    }
    .reelItem{
      width: min(92%, 520px);
      display:flex;
      align-items:center;
      gap:10px;
      background:#fff;
      border: 2px solid #000;
      border-radius: 999px;
      padding: 9px 10px;
      box-shadow: 2px 2px 0 #000;
      transform: translateZ(0);
      opacity:.95;
    }
    .reelItem img{
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 2px solid #000;
      object-fit: cover;
      background:#fff;
      flex: 0 0 auto;
    }
    .reelItem span{
      font-family: Montserrat;
      font-weight: 900;
      font-size: .85rem;
      text-transform: uppercase;
      line-height:1;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
      flex:1;
    }

    .tick{
      position:absolute;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: var(--primary);
      border: 2px solid #000;
      box-shadow: 2px 2px 0 #000;
      border-radius: 999px;
      padding: 4px 10px;
      font-family: Montserrat;
      font-weight: 900;
      font-size: 12px;
      opacity:0;
      z-index: 8;
      transition: opacity .06s ease;
    }
    .tick.show{ opacity:1; }

    .revealCard{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      opacity:0;
      transform: scale(.98);
      transition: opacity .35s ease, transform .35s ease;
      pointer-events:none;
      z-index: 5;
      padding: 12px;
      text-align:center;
    }
    .revealCard.show{opacity:1;transform: scale(1);}
    .revealPhoto{
      width: clamp(240px, 62%, 420px);
      aspect-ratio: 1 / 1;
      border: var(--border);
      border-radius: 999px;
      box-shadow: var(--shadow);
      overflow:hidden;
      background:#fff;
    }
    .revealPhoto img{
      width:100%;
      height:100%;
      object-fit: cover;
      object-position: 50% 28%;
      background:#fff;
      transform: scale(1.03);
    }
    .revealName{
      font-family: Montserrat;
      font-weight: 900;
      text-transform: uppercase;
      background: var(--primary);
      border: var(--border);
      box-shadow: var(--shadow-sm);
      border-radius: 999px;
      padding: 10px 14px;
      max-width: 95%;
      text-align:center;
    }
    .revealSub{ font-size:.75rem;font-weight: 900;color:#fff;opacity:.9; }

    .suspense{
      position:absolute; inset:0;
      background: rgba(0,0,0,.78);
      display:flex; align-items:center; justify-content:center;
      flex-direction:column; gap:10px;
      opacity:0; pointer-events:none;
      transition: opacity .25s ease;
      z-index: 6;
      padding: 12px;
      text-align:center;
    }
    .suspense.show{ opacity:1; }
    .suspense .title{
      color: var(--primary);
      font-family: Montserrat;
      font-weight: 900;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: .5px;
    }
    .suspense .bar{width: min(420px, 92%);height: 12px;border: 2px solid #fff;border-radius: 999px;overflow:hidden;background:#111;}
    .suspense .bar > div{height:100%;width: 0%;background: var(--primary);animation: loadbar 1.1s ease forwards;}
    @keyframes loadbar{from{ width:0%; }to{ width:100%; }}
    .suspense .hint{color:#fff;font-weight: 900;font-size: 12px;opacity:.9;}

    .glitch{ animation: glitch .2s steps(2) 1; }
    @keyframes glitch{
      0%{ filter: none; transform: translate(0,0); }
      25%{ filter: contrast(1.3) saturate(1.3); transform: translate(2px,-1px); }
      50%{ filter: hue-rotate(8deg); transform: translate(-2px,1px); }
      75%{ filter: contrast(1.2); transform: translate(1px,0); }
      100%{ filter:none; transform: translate(0,0); }
    }

    .shake{ animation: shake .55s cubic-bezier(.2,1,.2,1); }
    @keyframes shake{
      0%{ transform: translate(0,0) rotate(0); }
      20%{ transform: translate(-2px,1px) rotate(-.6deg); }
      40%{ transform: translate(3px,-2px) rotate(.6deg); }
      60%{ transform: translate(-3px,2px) rotate(-.6deg); }
      80%{ transform: translate(2px,-1px) rotate(.6deg); }
      100%{ transform: translate(0,0) rotate(0); }
    }

    .revealCard.is-center .revealPhoto{
      border: 4px solid #ffd700;
      box-shadow:
        0 0 18px rgba(255,215,0,.95),
        0 0 42px rgba(255,215,0,.45),
        6px 6px 0 #000;
    }
    .revealCard.is-center::after{
      content: "★ CENTER ★";
      position: absolute;
      top: 12px;
      right: 12px;
      background: #ffd700;
      color: #000;
      font-family: Montserrat;
      font-weight: 900;
      font-size: 12px;
      padding: 6px 12px;
      border: 2px solid #000;
      border-radius: 999px;
      box-shadow: 3px 3px 0 #000;
      transform: rotate(6deg);
      z-index: 10;
    }

    /* banner fileira completa (sem modal) */
    .banner{
      margin-top: 10px;
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 10px 12px;
      background:#fff;
      font-family: Montserrat;
      font-weight: 900;
      text-transform: uppercase;
      display:none;
    }
    .banner.show{ display:block; }
    .banner .ok{
      background: var(--primary);
      border: 2px solid #000;
      box-shadow: 2px 2px 0 #000;
      border-radius: 999px;
      padding: 4px 10px;
      display:inline-block;
      margin-right: 8px;
    }

    @media (max-width: 720px){
      .rowDots{ gap:8px; }
      .dot{ width: 54px; height:54px; }
      .dot .num{ font-size: 12px; }
      .rows[data-tight="7"] .dot{ width: 48px; height:48px; }
      .rows[data-tight="8"] .dot{ width: 44px; height:44px; }
      .dot .q{ font-size: 22px; }

      .machineGrid{
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .panel.leftDesktop,
      .panel.rightDesktop{ display:none; }
      .slot{ min-height: 520px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">ZAP<span>48</span> <span style="font-style:normal;color:#000">FORMATION</span></div>
      <div class="controls">
        <select id="singleSelect"></select>
        <select id="modeSelect" title="Modo">
          <option value="auto">AUTO</option>
          <option value="manual">MANUAL</option>
        </select>
        <button class="btn" id="checkBtn">CHECK</button>
        <button class="btn alt" id="showAllBtn">MOSTRAR TUDO</button>
        <button class="btn alt" id="resetBtn">RESET</button>
      </div>
    </div>

    <div class="card">
      <!-- OVERVIEW -->
      <div class="screen fadeUpIn" id="screenOverview">
        <div class="ovTop">
          <div><span class="tag" id="singleTag">SINGLE</span></div>
          <div class="ovHint" id="progressText">0 reveladas</div>
        </div>
        <div class="rows" id="overviewRows"></div>

        <div class="banner" id="rowBanner">
          <span class="ok">OK</span>
          <span id="rowBannerText">FILEIRA COMPLETADA</span>
        </div>
      </div>

      <!-- MACHINE -->
      <div class="screen hidden" id="screenMachine">
        <div class="machineGrid" id="machine">

          <div class="panel leftDesktop">
            <div class="rowTag"><span id="rowText">—列目</span><span style="opacity:.6">•</span><span>No.</span></div>
            <div class="bigNoWrap">
              <div class="bigNo" id="bigNo">?</div>
            </div>
          </div>

          <div class="slot">
            <div class="slotArch" id="slotArch">
              <div class="reel">
                <div class="reelList" id="reelList"></div>
              </div>

              <div class="revealCard" id="revealCard">
                <div class="revealPhoto"><img id="revealImg" alt=""></div>
                <div class="revealName" id="revealName">—</div>
                <div class="revealSub" id="revealSub">—</div>
              </div>

              <div class="suspense" id="suspense">
                <div class="title" id="suspenseTitle">FINAL CHECK</div>
                <div class="bar"><div></div></div>
                <div class="hint" id="suspenseHint">DRUM ROLL…</div>
              </div>

              <div class="tick" id="tick">CLICK</div>
            </div>
          </div>

          <div class="panel rightDesktop">
            <div class="rowTag" style="justify-content:center;width:100%;">DICA</div>
            <div style="margin-top:10px;font-size:.75rem;font-weight:900;opacity:.85;">
              AUTO: revela a fileira inteira<br>
              MANUAL: revela 1 por clique
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   SUPABASE (COLE SUAS CHAVES)
   ========================= */
const SUPABASE_URL = "https://iooyygtaosshxygnhlco.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlvb3l5Z3Rhb3NzaHh5Z25obGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDEyNTUsImV4cCI6MjA4NDU3NzI1NX0.gfcVtNgn3g1gnFVrtaIqzkWxajYiV_KbtycYsE9OZ0Y";

/* TABELA */
const TABLE_FORMATION = "formation_machine";

/* =========================
   REFS
   ========================= */
const singleSelect = document.getElementById("singleSelect");
const modeSelect = document.getElementById("modeSelect");
const checkBtn = document.getElementById("checkBtn");
const showAllBtn = document.getElementById("showAllBtn");
const resetBtn = document.getElementById("resetBtn");

const screenOverview = document.getElementById("screenOverview");
const screenMachine = document.getElementById("screenMachine");

const overviewRows = document.getElementById("overviewRows");
const progressText = document.getElementById("progressText");
const singleTag = document.getElementById("singleTag");

const rowBanner = document.getElementById("rowBanner");
const rowBannerText = document.getElementById("rowBannerText");

const machine = document.getElementById("machine");
const slotArch = document.getElementById("slotArch");
const rowText = document.getElementById("rowText");
const bigNo = document.getElementById("bigNo");

const reelList = document.getElementById("reelList");
const revealCard = document.getElementById("revealCard");
const revealImg = document.getElementById("revealImg");
const revealName = document.getElementById("revealName");
const revealSub = document.getElementById("revealSub");

const suspense = document.getElementById("suspense");
const suspenseTitle = document.getElementById("suspenseTitle");
const suspenseHint = document.getElementById("suspenseHint");
const tick = document.getElementById("tick");

/* =========================
   STATE
   ========================= */
let sb = null;
let formations = [];      // lista do banco
let currentFormation = null;

let members = [];         // membros da formation (com posNo)
let revealQueue = [];     // ordem de revelação
let currentIndex = 0;
let busy = false;

/* =========================
   UTILS
   ========================= */
const sleep = (ms) => new Promise(r => setTimeout(r, ms));
function pulseAnim(el, cls){ el.classList.remove(cls); void el.offsetWidth; el.classList.add(cls); }
function showOverview(){ screenMachine.classList.add("hidden"); screenOverview.classList.remove("hidden"); }
function showMachine(){ screenOverview.classList.add("hidden"); screenMachine.classList.remove("hidden"); }
function banner(msg){
  rowBannerText.textContent = msg;
  rowBanner.classList.add("show");
  setTimeout(()=>rowBanner.classList.remove("show"), 1400);
}

function storageKey(single_id){ return `zap48_formation_progress_${single_id}`; }

function saveProgress(){
  if(!currentFormation) return;
  const key = storageKey(currentFormation.single_id);
  const revealed = members.filter(m=>m._revealed).map(m=>m.pos_no);
  const showAll = members.every(m=>m._revealed);
  localStorage.setItem(key, JSON.stringify({ revealed, showAll }));
}

function loadProgress(){
  if(!currentFormation) return;
  const key = storageKey(currentFormation.single_id);
  try{
    const obj = JSON.parse(localStorage.getItem(key) || "null");
    if(!obj) return;

    const set = new Set((obj.revealed||[]).map(Number));
    members.forEach(m => m._revealed = set.has(m.pos_no) || !!obj.showAll);

    // acha o próximo index baseado em revealQueue
    currentIndex = 0;
    while (currentIndex < revealQueue.length && revealQueue[currentIndex]._revealed) currentIndex++;
  }catch(e){}
}

function buildPosNo(list){
  // posNo = 1..N baseado em row (1 frente) e seat
  const sorted = [...list].sort((a,b)=>{
    if((a.row||0)!==(b.row||0)) return (a.row||0)-(b.row||0);
    return (a.seat||0)-(b.seat||0);
  });
  let pos = 1;
  const map = new Map();
  for(const m of sorted){
    map.set(m, pos++);
  }
  return list.map(m => ({...m, pos_no: map.get(m)}));
}

function getMaxRowSize(){
  const sizes = {};
  members.forEach(m => { sizes[m.row] = (sizes[m.row]||0) + 1; });
  return Math.max(...Object.values(sizes));
}

function updateProgress(){
  const revealedCount = members.filter(m => m._revealed).length;
  progressText.textContent = `${revealedCount} reveladas • ${members.length - revealedCount} com ?`;
  checkBtn.disabled = (revealedCount >= members.length);
  showAllBtn.disabled = (revealedCount >= members.length);
}

function renderOverview(){
  const maxSize = getMaxRowSize();
  overviewRows.dataset.tight = (maxSize >= 8) ? "8" : (maxSize >= 7 ? "7" : "");

  const byRow = {};
  members.forEach(m => {
    if(!byRow[m.row]) byRow[m.row] = [];
    byRow[m.row].push(m);
  });

  const rows = Object.keys(byRow).map(Number).sort((a,b)=>b-a); // trás em cima

  overviewRows.innerHTML = rows.map(r => {
    const rowMembers = byRow[r].sort((a,b)=>(a.seat||0)-(b.seat||0));
    const dots = rowMembers.map(m => {
      const cls = ["dot", m._revealed ? "revealed" : "", m.is_center ? "center" : ""].join(" ");
      return `
        <div class="${cls}">
          <img src="${m.photo_url}" alt="">
          <div class="q">?</div>
          <div class="num">${m.pos_no}</div>
        </div>
      `;
    }).join("");

    return `
      <div>
        <div class="rowDots">${dots}</div>
        <div class="rowLabel">${r}列目</div>
      </div>
    `;
  }).join("");
}

/* =========================
   REVEAL ORDER
   - Aqui o No é posição (pos_no)
   - Reveal padrão: por row de trás->frente OU pela reveal_order do admin se tiver.
   ========================= */
function buildRevealQueue(list){
  const hasRevealOrder = list.some(m => Number.isFinite(Number(m.reveal_order)));
  let ordered;

  if(hasRevealOrder){
    ordered = [...list].sort((a,b)=>(Number(a.reveal_order)||999999)-(Number(b.reveal_order)||999999));
  }else{
    // default: revela por row de trás para frente, e seat
    ordered = [...list].sort((a,b)=>{
      if((a.row||0)!==(b.row||0)) return (b.row||0)-(a.row||0); // trás primeiro
      return (a.seat||0)-(b.seat||0);
    });
  }

  return ordered;
}

function getNextUnrevealed(){
  while (currentIndex < revealQueue.length && revealQueue[currentIndex]._revealed) currentIndex++;
  return (currentIndex < revealQueue.length) ? revealQueue[currentIndex] : null;
}

function makeReelItems(){
  const pool = [...members].sort(() => Math.random()-0.5).slice(0, 12);
  return pool.map(p => `
    <div class="reelItem">
      <img src="${p.photo_url}" alt="">
      <span>${p.name}</span>
    </div>
  `).join("");
}

async function tickFlash(){
  tick.classList.add("show");
  await sleep(45);
  tick.classList.remove("show");
}

async function centerSuspense(longer){
  suspenseTitle.textContent = "FINAL CHECK";
  suspenseHint.textContent = "DRUM ROLL…";
  suspense.classList.add("show");
  await sleep(longer ? 1800 : 1150);
  suspense.classList.remove("show");
}

function resetMachineUI(){
  revealCard.classList.remove("show", "is-center");
  revealImg.src = "";
  revealName.textContent = "—";
  revealSub.textContent = "—";
  rowText.textContent = "—列目";
  bigNo.textContent = "?";
  suspense.classList.remove("show");
  slotArch.classList.remove("lit");
  tick.classList.remove("show");
  reelList.style.transform = "translateY(0px)";
}

/* =========================
   COMPLETE ROW CHECK
   ========================= */
function isRowComplete(row){
  const rowMs = members.filter(m=>Number(m.row)===Number(row));
  return rowMs.length > 0 && rowMs.every(m=>m._revealed);
}

/* =========================
   REVEAL (MANUAL: 1 por clique)
   ========================= */
async function revealOne(){
  if (busy) return;

  const m = getNextUnrevealed();
  if(!m){
    showOverview();
    updateProgress();
    return;
  }

  busy = true;
  showMachine();
  resetMachineUI();

  slotArch.classList.add("lit");
  reelList.innerHTML = makeReelItems() + makeReelItems() + makeReelItems();

  // roleta curtinha
  const start = performance.now();
  const total = m.is_center ? 820 : 520;        // center mais demorado
  const maxMove = m.is_center ? 1200 : 900;

  while(true){
    const t = Math.min(1, (performance.now()-start)/total);
    const eased = t < .5 ? 4*t*t*t : 1 - Math.pow(-2*t+2, 3)/2;
    reelList.style.transform = `translateY(${-maxMove*eased}px)`;
    if(t > 0.1 && t < 0.92) tickFlash();
    if(t >= 1) break;
    await sleep(16);
  }

  await tickFlash();
  pulseAnim(machine, "shake");

  // center suspense extra
  if(m.is_center){
    slotArch.classList.add("glitch");
    await sleep(200);
    slotArch.classList.remove("glitch");
    await centerSuspense(true);
  }

  rowText.textContent = `${m.row ?? "—"}列目`;
  bigNo.textContent = String(m.pos_no);

  revealImg.src = m.photo_url;
  revealName.textContent = m.name || "—";
  revealSub.textContent = m.is_center ? "CENTER" : `ROW ${m.row} • OK`;
  revealCard.classList.toggle("is-center", !!m.is_center);
  revealCard.classList.add("show");

  // marca revelado
  m._revealed = true;
  currentIndex++;

  await sleep(m.is_center ? 1200 : 700);
  slotArch.classList.remove("lit");

  // atualiza overview sem popup
  renderOverview();
  updateProgress();
  saveProgress();

  // se completou a fileira do membro revelado
  if(isRowComplete(m.row)){
    banner(`FILEIRA ${m.row} COMPLETADA!`);
  }

  showOverview();
  busy = false;
}

/* =========================
   REVEAL (AUTO: fileira inteira por clique)
   ========================= */
async function revealRowAuto(){
  if (busy) return;
  if (members.every(x => x._revealed)){
    showOverview();
    updateProgress();
    return;
  }

  const next = getNextUnrevealed();
  if (!next){
    showOverview();
    updateProgress();
    return;
  }

  busy = true;
  checkBtn.disabled = true;
  showMachine();

  const targetRow = next.row;

  while(true){
    const currentNext = getNextUnrevealed();
    if(!currentNext) break;
    if(currentNext.row !== targetRow) break;

    resetMachineUI();
    slotArch.classList.add("lit");
    reelList.innerHTML = makeReelItems() + makeReelItems() + makeReelItems();

    const isCenter = !!currentNext.is_center;

    const start = performance.now();
    const total = isCenter ? 820 : 520;
    const maxMove = isCenter ? 1200 : 900;

    while(true){
      const t = Math.min(1, (performance.now()-start)/total);
      const eased = t < .5 ? 4*t*t*t : 1 - Math.pow(-2*t+2, 3)/2;
      reelList.style.transform = `translateY(${-maxMove*eased}px)`;
      if(t > 0.1 && t < 0.92) tickFlash();
      if(t >= 1) break;
      await sleep(16);
    }

    if(isCenter){
      slotArch.classList.add("glitch");
      await sleep(200);
      slotArch.classList.remove("glitch");
      await centerSuspense(true);
    }

    rowText.textContent = `${currentNext.row ?? "—"}列目`;
    bigNo.textContent = String(currentNext.pos_no);

    revealImg.src = currentNext.photo_url;
    revealName.textContent = currentNext.name || "—";
    revealSub.textContent = isCenter ? "CENTER" : `ROW ${currentNext.row} • OK`;
    revealCard.classList.toggle("is-center", isCenter);
    revealCard.classList.add("show");

    currentNext._revealed = true;
    currentIndex++;

    await sleep(isCenter ? 1200 : 650);
    slotArch.classList.remove("lit");

    renderOverview();
    updateProgress();
    saveProgress();

    if(members.every(x => x._revealed)) break;
  }

  // fileira completada (sem modal)
  banner(`FILEIRA ${targetRow} COMPLETADA!`);

  await sleep(160);
  showOverview();
  updateProgress();
  checkBtn.disabled = members.every(x => x._revealed);
  busy = false;
}

/* =========================
   SHOW ALL
   ========================= */
function showAllNow(){
  members.forEach(m=>m._revealed=true);
  renderOverview();
  updateProgress();
  saveProgress();
  banner("MOSTRANDO TUDO");
}

/* =========================
   RESET PROGRESS (somente local)
   ========================= */
function resetProgress(){
  if(!currentFormation) return;
  const key = storageKey(currentFormation.single_id);
  localStorage.removeItem(key);

  members.forEach(m=>m._revealed=false);
  currentIndex = 0;
  renderOverview();
  updateProgress();
  banner("RESET OK");
}

/* =========================
   LOAD FROM DB
   ========================= */
async function loadFormations(){
  // pega published = true
  const { data, error } = await sb
    .from(TABLE_FORMATION)
    .select("id, title, single_id, members, published")
    .eq("published", true)
    .order("single_id", { ascending: true });

  if(error){
    console.error(error);
    singleSelect.innerHTML = `<option value="">Erro</option>`;
    singleTag.textContent = "ERRO";
    progressText.textContent = "Ver console (F12)";
    return;
  }

  formations = data || [];
  if(!formations.length){
    singleSelect.innerHTML = `<option value="">(sem published)</option>`;
    singleTag.textContent = "SEM FORMATIONS";
    progressText.textContent = "publique no admin";
    return;
  }

  singleSelect.innerHTML = formations.map(f=>{
    const label = `${f.single_id}th`;
    return `<option value="${f.id}">${label}</option>`;
  }).join("");

  // carrega primeira
  singleSelect.value = formations[0].id;
  await loadFormationById(formations[0].id);
}

async function loadFormationById(id){
  const f = formations.find(x=>String(x.id)===String(id));
  if(!f) return;

  currentFormation = f;

  singleTag.textContent = f.title || `${f.single_id}th • formation`;

  // members do banco
  const list = Array.isArray(f.members) ? f.members : [];

  // normaliza + pos_no
  members = buildPosNo(list).map(m=>({
    id: m.id,
    name: m.name,
    photo_url: m.photo_url,
    row: Number(m.row||1),
    seat: Number(m.seat||1),
    is_center: !!m.is_center,
    reveal_order: Number(m.reveal_order||0) || null,
    pos_no: Number(m.pos_no),
    _revealed: false
  }));

  revealQueue = buildRevealQueue(members);
  currentIndex = 0;

  // restore local progress
  loadProgress();

  renderOverview();
  updateProgress();
  showOverview();

  banner("PROGRESSO RESTAURADO (SE EXISTIA)");
}

/* =========================
   EVENTS
   ========================= */
checkBtn.addEventListener("click", async ()=>{
  const mode = modeSelect.value;
  if(mode === "manual"){
    await revealOne();
  }else{
    await revealRowAuto();
  }
});

showAllBtn.addEventListener("click", showAllNow);
resetBtn.addEventListener("click", resetProgress);

singleSelect.addEventListener("change", async ()=>{
  await loadFormationById(singleSelect.value);
});

/* =========================
   INIT
   ========================= */
(function init(){
  if(typeof window.supabase === "undefined"){
    singleTag.textContent = "SUPABASE NÃO CARREGOU";
    return;
  }
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes("COLE_AQUI")){
    singleTag.textContent = "COLE SUAS CHAVES NO TOPO";
    progressText.textContent = "SUPABASE_URL / SUPABASE_ANON_KEY";
    return;
  }
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  loadFormations();
})();
</script>
</body>
</html>
